-- Veri Tabanı Oluşturma İşlemi.
CREATE DATABASE NovaStoreDB;
GO

-- Oluşturulan Veri Tabanını Kullanma İşlemi.
USE NovaStoreDB;
GO

-- Kategoriler Tablosunu Oluşturma İşlemi.
CREATE TABLE Categories(
       CategoryID INT PRIMARY KEY IDENTITY(1,1),
	   CategoryName NVARCHAR(50) NOT NULL
);

-- Müşteriler Tablosunu Oluşturma İşlemi.
CREATE TABLE Customers(
     CustomerID INT PRIMARY KEY IDENTITY(1,1),
	   FullName NVARCHAR (30),
	   City NVARCHAR (50),
	   Email NVARCHAR (100) UNIQUE
);

-- Ürünler Tablosunu Oluşturma İşlemi.
CREATE TABLE Products(
       ProductID INT PRIMARY KEY IDENTITY(1,1),
	   ProductName NVARCHAR(100) NOT NULL,
	   Price DECIMAL(10,2),
	   Stock INT DEFAULT 0,
	   CategoryID INT,
	   CONSTRAINT FK_Products_Categories FOREIGN KEY (CategoryID)
	   REFERENCES Categories(CategoryID)
);

-- Sipariş Tablosunu Oluşturma İşlemi.
CREATE TABLE Orders(
       OrderID INT PRIMARY KEY IDENTITY(1,1),
	   CustomerID INT,
	   OrderDate DATETIME DEFAULT GETDATE(),
	   TotalAmount DECIMAL(10,2),
	   CONSTRAINT FK_Orders_Customers FOREIGN KEY (CustomerID)
	   REFERENCES Customers(CustomerID)
);

-- Sipariş Detay Tablosunu Oluşturma İşlemi.
CREATE TABLE OrderDetails(
       DetailID INT PRIMARY KEY IDENTITY(1,1),
	   OrderID INT,
	   ProductID INT,
	   Quantity INT,
	   CONSTRAINT FK_OrderDetails_Orders FOREIGN KEY (OrderID) 
       REFERENCES Orders(OrderID),
       CONSTRAINT FK_OrderDetails_Products FOREIGN KEY (ProductID) 
       REFERENCES Products(ProductID)
);

-- Kategori Tablosuna Kategori Ekleme İşlemi.
INSERT INTO Categories (CategoryName) VALUES
('Elektronik'),
('Giyim'),
('Kitap'),
('Kozmetik'),
('Ev ve Yaşam');

-- Müşteriler Tablosuna Müşteri Ekleme İşlemi.
INSERT INTO Customers (FullName, City, Email) VALUES
('Ahmet Yılmaz', 'İstanbul', 'ahmet.yilmaz@email.com'),
('Ayşe Demir', 'Ankara', 'ayse.demir@email.com'),
('Mehmet Kaya', 'İzmir', 'mehmet.kaya@email.com'),
('Fatma Şahin', 'Bursa', 'fatma.sahin@email.com'),
('Caner Özkan', 'Antalya', 'caner.ozkan@email.com'),
('Zeynep Aksoy', 'Eskişehir', 'zeynep.aksoy@email.com');

-- Ürünler Tablosuna Ürün Ekleme İşlemi.
INSERT INTO Products (ProductName, Price, Stock, CategoryID) VALUES
('Akıllı Telefon', 25000.00, 15, 1),
('Dizüstü Bilgisayar', 45000.00, 8, 1),
('Kablosuz Kulaklık', 3500.00, 50, 1),
('Pamuklu Tişört', 450.00, 100, 2),
('Kışlık Mont', 2200.00, 12, 2),       
('SQL Öğreniyorum Kitabı', 250.00, 30, 3),
('Dünya Klasikleri Seti', 1200.00, 20, 3),
('Nemlendirici Krem', 600.00, 45, 4),    
('Parfüm Seti', 1800.00, 10, 4),       
('Kahve Makinesi', 4200.00, 5, 5),
('Nevresim Takımı', 1500.00, 25, 5),
('Dekoratif Lamba', 850.00, 18, 5);

-- Sipariş Tablosuna Sipariş Ekleme İşlemi.
INSERT INTO Orders (CustomerID, OrderDate, TotalAmount) VALUES
(1, '2023-05-10 10:30:00', 25450.00), 
(2, '2022-05-12 14:20:00', 450.00),   
(1, '2022-05-15 09:15:00', 3500.00),  
(3, '2025-10-20 16:45:00', 1200.00),  
(4, '2024-01-06 11:00:00', 2400.00),  
(5, '2026-01-25 19:30:00', 4200.00),  
(6, '2024-05-28 13:10:00', 600.00),   
(2, '2025-04-30 08:50:00', 25000.00), 
(3, '2024-06-01 15:00:00', 850.00),
(4, '2024-06-02 17:20:00', 2200.00);

-- Sipariş Detay Tablosuna Detay Ekleme İşlemi.
INSERT INTO OrderDetails (OrderID, ProductID, Quantity) VALUES
(1, 1, 1), (1, 4, 1),
(2, 4, 1),
(3, 3, 1),
(4, 7, 1),
(5, 8, 4),
(6, 10, 1),
(7, 8, 1),
(8, 1, 1),
(9, 12, 1),
(10, 5, 1);

-- OLUŞTURULAN TABLOLAR İÇİN SORGU BÖLÜMÜ

-- Stok miktarı 20'den az olan ürünlerin adını ve stok miktarını, stok miktarına göre "AZALAN" sırada listeleme işlemi.
SELECT ProductName , Stock 
FROM Products
WHERE Stock < 20 
ORDER BY Stock DESC;

-- Hangi müşteri, hangi tarihte sipariş vermiş? Müşteri Adı, Şehir, Sipariş Tarihi ve Toplam Tutar listeleme işlemi.
SELECT C.FullName, C.City, O.OrderDate,O.TotalAmount
FROM Customers C
INNER JOIN Orders O ON C.CustomerID = O.CustomerID;

-- "Zeynep Aksoy" isimli müşterinin aldığı ürünlerin isimlerini, fiyatlarını ve kategorilerini listeleme işlemi.
SELECT P.ProductName, P.Price, CAT.CategoryName
FROM Customers C
JOIN Orders O ON C.CustomerID = O.CustomerID
JOIN OrderDetails OD ON O.OrderID = OD.OrderID
JOIN Products P ON OD.ProductID = P.ProductID
JOIN Categories CAT ON P.CategoryID = CAT.CategoryID
WHERE C.FullName = 'Zeynep Aksoy';

-- Hangi kategoride toplam kaç adet ürünümüz var?
SELECT CAT.CategoryName, COUNT(P.ProductID) AS ToplamUrunSayisi
FROM Categories CAT
LEFT JOIN Products P ON CAT.CategoryID = P.CategoryID
GROUP BY CAT.CategoryName;

-- Her müşterinin şirkete kazandırdığı toplam ciro nedir? En çok harcama yapandan en aza doğru Sıralama işlemi.
SELECT C.FullName, SUM(O.TotalAmount) AS ToplamCiro
FROM Customers C
JOIN Orders O ON C.CustomerID = O.CustomerID
GROUP BY C.FullName
ORDER BY ToplamCiro DESC;

-- Bugünün tarihine göre, siparişlerin üzerinden kaç gün geçtiğini hesaplayın.
SELECT OrderID, OrderDate, GETDATE() AS Bugun,
DATEDIFF(DAY,OrderDate,GETDATE()) AS GecenGun
FROM Orders;

-- Müşteri Adı, Sipariş Tarihi, Ürün Adı ve Adet bilgilerini  tek bir tablodaymış gibi getiren vw_SiparisOzet isminde bir VIEW oluşturma İşlemi.
CREATE VIEW vw_SiparisOzet AS
SELECT C.FullName AS MusteriAdi,
       O.OrderDate AS SiparisTarihi,
	   P.ProductName AS UrunAdi,
	   OD.Quantity AS Adet
FROM Customers C
JOIN Orders O ON C.CustomerID = O.CustomerID
JOIN OrderDetails OD ON O.OrderID = OD.OrderID
JOIN Products P ON OD.ProductID = P.ProductID;
GO

SELECT * FROM vw_SiparisOzet;

-- NovaStoreDB Veri Tabanının C:\Yedek\ klasörüne yedeğini alan T-SQL komutunu.
BACKUP DATABASE NovaStoreDB
TO DISK = 'C:\Yedek\NovaStoreDB.bak'
WITH FORMAT,
MEDIANAME = 'SQLServerBackups',
NAME = 'Full Backup of NovaStoreDB';
GO
